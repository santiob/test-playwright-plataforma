name: Playwright Tests - Multi Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
#  schedule:
    # Ejecutar cada 6 horas
  #  - cron: '0 */6 * * *'
  workflow_dispatch:
    # Permitir ejecución manual

jobs:
  test:
    name: Test ${{ matrix.platform }}
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    # ⭐ Matrix strategy para ejecutar en paralelo las 2 plataformas
    strategy:
      fail-fast: false
      matrix:
        platform: [plataforma-rionegrina, plataforma-secundaria]
        include:
          - platform: plataforma-rionegrina
            base_url: https://uat-rn-lotline.tecnoaccion.com.ar
            username_secret: TEST_USERNAME_RIONEGRINA
            password_secret: TEST_PASSWORD_RIONEGRINA
          - platform: plataforma-secundaria
            base_url: https://url-segunda-plataforma.com
            username_secret: TEST_USERNAME_SECUNDARIA
            password_secret: TEST_PASSWORD_SECUNDARIA
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Instalar dependencias
      run: npm install
    
    - name: Instalar navegadores Playwright
      run: npx playwright install --with-deps chromium
    
    - name: Ejecutar tests de Playwright para ${{ matrix.platform }}
      env:
        TEST_USERNAME: ${{ secrets[matrix.username_secret] }}
        TEST_PASSWORD: ${{ secrets[matrix.password_secret] }}
        BASE_URL_RIONEGRINA: ${{ matrix.base_url }}
        BASE_URL_SECUNDARIA: ${{ matrix.base_url }}
      run: npx playwright test --project=${{ matrix.platform }}
    
    - name: Upload Playwright Report - ${{ matrix.platform }}
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.platform }}
        path: playwright-report/
        retention-days: 30
    
    - name: Upload Test Results - ${{ matrix.platform }}
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.platform }}
        path: test-results/
        retention-days: 30
    
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: test-results/junit.xml
        check_name: Test Results - ${{ matrix.platform }}
